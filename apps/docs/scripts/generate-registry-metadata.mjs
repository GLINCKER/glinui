import { readFileSync, writeFileSync } from "node:fs"
import { dirname, join, resolve } from "node:path"
import { fileURLToPath } from "node:url"
import vm from "node:vm"
import ts from "typescript"

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)
const root = resolve(__dirname, "..", "..", "..")

const registrySourceFile = join(root, "packages", "registry", "src", "index.ts")
const registryArtifactsIndexFile = join(
  root,
  "packages",
  "registry",
  "artifacts",
  "index.json"
)
const outputFile = join(root, "apps", "docs", "src", "lib", "generated-registry-metadata.ts")

function tryParseExistingRegistryItems() {
  try {
    const source = readFileSync(outputFile, "utf8")
    const match = source.match(/export const generatedRegistryItems = (\[[\s\S]*?\]) as const/)
    if (!match) {
      return null
    }
    return JSON.parse(match[1])
  } catch {
    return null
  }
}

function normalizeItems(items) {
  return items.map((item) => ({
    name: String(item.name),
    type: item.type === "signature" ? "signature" : "primitive",
    title: String(item.title),
    description: String(item.description),
    docsPath: String(item.docsPath),
    importPath: String(item.importPath),
    install: {
      package: String(item.install?.package ?? ""),
      registry: String(item.install?.registry ?? "")
    }
  }))
}

function loadRegistryItemsFromArtifacts() {
  try {
    const source = readFileSync(registryArtifactsIndexFile, "utf8")
    const parsed = JSON.parse(source)
    if (!Array.isArray(parsed.items)) {
      return null
    }
    return normalizeItems(parsed.items)
  } catch {
    return null
  }
}

function loadRegistryItemsFromSource() {
  const source = readFileSync(registrySourceFile, "utf8")
  const transpiled = ts.transpileModule(source, {
    compilerOptions: {
      target: ts.ScriptTarget.ES2020,
      module: ts.ModuleKind.CommonJS
    }
  }).outputText

  const module = { exports: {} }
  const context = vm.createContext({
    module,
    exports: module.exports
  })

  vm.runInContext(transpiled, context, { filename: registrySourceFile })
  const exported = module.exports
  const items = exported.baseRegistry

  if (!Array.isArray(items)) {
    throw new Error("Unable to read baseRegistry from packages/registry/src/index.ts")
  }

  return normalizeItems(items)
}

function loadRegistryItems() {
  const artifactItems = loadRegistryItemsFromArtifacts()
  if (artifactItems) {
    return artifactItems
  }
  return loadRegistryItemsFromSource()
}

function build() {
  const items = loadRegistryItems()
  const existingItems = tryParseExistingRegistryItems()
  const nextItemsJson = JSON.stringify(items, null, 2)
  const existingItemsJson = existingItems ? JSON.stringify(existingItems, null, 2) : null

  if (existingItemsJson === nextItemsJson) {
    // eslint-disable-next-line no-console
    console.log(`generated ${items.length} registry docs entries (no changes) -> ${outputFile}`)
    return
  }

  const primitiveIds = items.filter((item) => item.type === "primitive").map((item) => item.name)
  const signatureIds = items.filter((item) => item.type === "signature").map((item) => item.name)

  const byName = Object.fromEntries(items.map((item) => [item.name, item]))
  const titles = Object.fromEntries(items.map((item) => [item.name, item.title]))
  const descriptions = Object.fromEntries(items.map((item) => [item.name, item.description]))
  const generatedAt = new Date().toISOString()

  const output = `/* eslint-disable */
// Auto-generated by apps/docs/scripts/generate-registry-metadata.mjs
// Do not edit manually.

export type GeneratedRegistryType = "primitive" | "signature"

export type GeneratedRegistryEntry = {
  name: string
  type: GeneratedRegistryType
  title: string
  description: string
  docsPath: string
  importPath: string
  install: {
    package: string
    registry: string
  }
}

export const generatedRegistryItems = ${nextItemsJson} as const
export const generatedRegistryByName = ${JSON.stringify(byName, null, 2)} as const
export const generatedPrimitiveComponentIds = ${JSON.stringify(primitiveIds, null, 2)} as const
export const generatedSignatureComponentIds = ${JSON.stringify(signatureIds, null, 2)} as const
export const generatedComponentTitles = ${JSON.stringify(titles, null, 2)} as const
export const generatedComponentDescriptions = ${JSON.stringify(descriptions, null, 2)} as const
export const generatedRegistryMetadataGeneratedAt = "${generatedAt}" as const
`

  writeFileSync(outputFile, output, "utf8")
  // eslint-disable-next-line no-console
  console.log(`generated ${items.length} registry docs entries -> ${outputFile}`)
}

build()
